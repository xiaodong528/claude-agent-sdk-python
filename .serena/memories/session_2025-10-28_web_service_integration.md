# Web æœåŠ¡é›†æˆå®æ–½ä¼šè¯è®°å½•
**æ—¥æœŸ**: 2025-10-28  
**ä»»åŠ¡**: å¢å¼ºè®¡ç®—å™¨åº”ç”¨æ”¯æŒ Web å‰ç«¯å’Œç«¯å£æš´éœ²

## ğŸ“‹ å®æ–½ç›®æ ‡

åŸºäºç”¨æˆ·éœ€æ±‚ï¼Œå¢å¼ºç¬¬äº”æ­¥çš„å®ç°ï¼š
1. ä¿®æ”¹ `code/calculator.py` ç”Ÿæˆå¸¦ Web å‰ç«¯çš„è®¡ç®—å™¨åº”ç”¨
2. å‰ç«¯éƒ¨ç½²åˆ° 3000 ç«¯å£
3. åœ¨ `apps/calculator.py` ä¸­è·å–å¹¶æ˜¾ç¤ºæœåŠ¡çš„å¤–éƒ¨ URL
4. ä½¿ç”¨ E2B Sandbox çš„ç«¯å£æš´éœ²åŠŸèƒ½

## âœ… å®Œæˆçš„å·¥ä½œ

### 1. E2B ç«¯å£æš´éœ²æœºåˆ¶ç ”ç©¶

#### æ ¸å¿ƒ API

| API æ–¹æ³• | å‚æ•° | è¿”å›å€¼ | è¯´æ˜ |
|---------|------|--------|------|
| `sandbox.get_hostname(port)` | `port: int` | `str` (å®Œæ•´ URL) | è·å–æŒ‡å®šç«¯å£çš„å¤–éƒ¨è®¿é—® URL |
| `sandbox.get_host(port)` | `port: int` | `str` (hostname) | è·å–æŒ‡å®šç«¯å£çš„ä¸»æœºåï¼ˆéœ€æ‹¼æ¥åè®®ï¼‰ |

#### URL æ ¼å¼

E2B è‡ªåŠ¨ä¸ºæ¯ä¸ªæš´éœ²çš„ç«¯å£ç”Ÿæˆå”¯ä¸€çš„å¤–éƒ¨ HTTPS URLï¼š
```
æ ¼å¼: https://{sandbox_id}-{port}.e2b.dev
ç¤ºä¾‹: https://abc123-3000.e2b.dev
```

### 2. æ–‡ä»¶ä¿®æ”¹è¯¦æƒ…

#### ä¿®æ”¹ 1: `src/code/calculator.py`

**ä¿®æ”¹å†…å®¹**:
- æ›´æ–° Agent ä»»åŠ¡æè¿°ï¼Œè¦æ±‚ç”Ÿæˆ Web åº”ç”¨è€Œéå‘½ä»¤è¡Œå·¥å…·
- è¦æ±‚åˆ›å»º `index.html` æ–‡ä»¶ï¼ˆç¾è§‚çš„ Web ç•Œé¢ï¼‰
- è¦æ±‚ä½¿ç”¨ Python http.server åœ¨ 3000 ç«¯å£å¯åŠ¨æœåŠ¡
- è¦æ±‚æœåŠ¡åœ¨åå°æŒç»­è¿è¡Œï¼ˆä½¿ç”¨ `nohup` æˆ– `&`ï¼‰
- æ·»åŠ è®¡ç®—å†å²è®°å½•ã€é”®ç›˜è¾“å…¥ç­‰é«˜çº§åŠŸèƒ½

**å…³é”®å˜æ›´**:
```python
await client.query("""
åˆ›å»ºä¸€ä¸ªå¸¦ Web å‰ç«¯çš„è®¡ç®—å™¨åº”ç”¨:

1. åˆ›å»º index.html æ–‡ä»¶:
   - ç¾è§‚çš„è®¡ç®—å™¨ç•Œé¢ï¼ˆä½¿ç”¨åŸç”Ÿ HTML + CSS + JavaScriptï¼‰
   - å®ç°åŠ å‡ä¹˜é™¤è¿ç®—åŠŸèƒ½
   - æ”¯æŒé”®ç›˜è¾“å…¥ï¼ˆæ•°å­—é”®å’Œè¿ç®—ç¬¦ï¼‰
   - æ˜¾ç¤ºè®¡ç®—å†å²è®°å½•
   - å“åº”å¼è®¾è®¡ï¼Œé€‚é…ä¸åŒå±å¹•
   - ä½¿ç”¨ç°ä»£åŒ–çš„ CSS æ ·å¼ï¼ˆæ¸å˜ã€é˜´å½±ã€åœ†è§’ï¼‰

2. å¯åŠ¨ Web æœåŠ¡:
   - ä½¿ç”¨ Python çš„ http.server æ¨¡å—åœ¨ 3000 ç«¯å£å¯åŠ¨æœåŠ¡
   - ç¡®ä¿æœåŠ¡åœ¨åå°æŒç»­è¿è¡Œï¼ˆä½¿ç”¨ nohup æˆ– & åå°è¿è¡Œï¼‰
   - æœåŠ¡å¯åŠ¨åæ‰“å°ç¡®è®¤æ¶ˆæ¯

3. åˆ›å»º README.md æ–‡ä»¶:
   - åº”ç”¨è¯´æ˜
   - åŠŸèƒ½åˆ—è¡¨
   - è®¿é—®æ–¹å¼ï¼ˆæœ¬åœ°å’Œè¿œç¨‹ï¼‰
   - ä½¿ç”¨æˆªå›¾æˆ–åŠŸèƒ½æ¼”ç¤º

è¦æ±‚:
- ç•Œé¢ç¾è§‚ã€ç°ä»£åŒ–
- ä»£ç ç®€æ´ã€æ³¨é‡Šæ¸…æ™°
- å®Œæˆåç«‹å³å¯åŠ¨æœåŠ¡å¹¶ä¿æŒè¿è¡Œ
- ä½¿ç”¨ä¸­æ–‡å›å¤æ‰€æœ‰æ¶ˆæ¯
""")
```

#### ä¿®æ”¹ 2: `src/agent_runner.py`

**æ–°å¢åŠŸèƒ½**: `run_code_with_service()` å‡½æ•°

**åŠŸèƒ½ç‰¹æ€§**:
```python
async def run_code_with_service(
    code_file: str,
    service_port: int,
    env_vars: Optional[dict] = None,
    wait_time: int = 3
) -> dict:
```

**å·¥ä½œæµç¨‹**:
1. è¯»å– Template ID
2. è¯»å–ä»£ç æ–‡ä»¶
3. åˆ›å»º Sandboxï¼ˆæ‰‹åŠ¨ç®¡ç†ç”Ÿå‘½å‘¨æœŸï¼Œä¸ä½¿ç”¨ Context Managerï¼‰
4. ä¸Šä¼ ä»£ç æ–‡ä»¶åˆ° Sandbox
5. æ‰§è¡Œä»£ç 
6. å¦‚æœæ‰§è¡ŒæˆåŠŸï¼ˆexit_code == 0ï¼‰:
   - ç­‰å¾…æœåŠ¡å¯åŠ¨ï¼ˆé»˜è®¤ 3 ç§’ï¼‰
   - è°ƒç”¨ `sandbox.get_hostname(port)` è·å–å¤–éƒ¨ URL
   - å°† URL æ·»åŠ åˆ°è¿”å›ç»“æœ
7. åˆ—å‡ºç”Ÿæˆçš„æ–‡ä»¶
8. **ä¸å…³é—­ Sandbox**ï¼Œä¿æŒæœåŠ¡è¿è¡Œ

**è¿”å›å€¼å¢å¼º**:
```python
return {
    "exit_code": 0,
    "files": ["index.html", "README.md"],
    "service_url": "https://xxx-3000.e2b.dev",
    "sandbox_id": "xxx",
    "keep_alive": True
}
```

**å…³é”®è®¾è®¡å†³ç­–**:
- **ä¸ä½¿ç”¨ Context Manager**: é¿å… Sandbox è‡ªåŠ¨å…³é—­
- **æ‰‹åŠ¨ç®¡ç†ç”Ÿå‘½å‘¨æœŸ**: åœ¨å‡ºé”™æ—¶æ‰å…³é—­ Sandbox
- **ç­‰å¾…æœåŠ¡å¯åŠ¨**: `await asyncio.sleep(wait_time)` ç¡®ä¿æœåŠ¡å°±ç»ª
- **ä¿æŒè¿è¡Œ**: è¿”å›å Sandbox ç»§ç»­è¿è¡Œï¼ŒæœåŠ¡ä¿æŒå¯ç”¨

#### ä¿®æ”¹ 3: `src/apps/calculator.py`

**ä¿®æ”¹å†…å®¹**:
- å¯¼å…¥ `run_code_with_service` æ›¿ä»£ `run_code_in_sandbox`
- è°ƒç”¨æ–°å‡½æ•°å¹¶ä¼ å…¥ `service_port=3000`
- å¢åŠ  `wait_time=5` ç»™æœåŠ¡æ›´å¤šå¯åŠ¨æ—¶é—´
- æ˜¾ç¤ºæœåŠ¡ URL å’Œ Sandbox ä¿¡æ¯
- æ·»åŠ ä½¿ç”¨æç¤º

**å…³é”®å˜æ›´**:
```python
# è°ƒç”¨æ–°çš„æœåŠ¡å‡½æ•°
result = await run_code_with_service(
    code_file="calculator.py",
    service_port=3000,
    env_vars={"ANTHROPIC_AUTH_TOKEN": anthropic_token},
    wait_time=5
)

# æ˜¾ç¤ºæœåŠ¡ä¿¡æ¯
if result.get('service_url'):
    print(f"âœ… å‰ç«¯åœ°å€: {result['service_url']}")
    print(f"âœ… Sandbox ID: {result['sandbox_id']}")
    print("\nğŸ’¡ ä½¿ç”¨æç¤º:")
    print("  1. åœ¨æµè§ˆå™¨ä¸­æ‰“å¼€ä¸Šè¿°åœ°å€è®¿é—®è®¡ç®—å™¨åº”ç”¨")
    print("  2. Sandbox å°†ä¿æŒè¿è¡Œçº¦ 1 å°æ—¶ï¼ˆ3600 ç§’ï¼‰")
    print("  3. æœåŠ¡è¶…æ—¶åä¼šè‡ªåŠ¨å…³é—­")
```

### 3. Sandbox ç”Ÿå‘½å‘¨æœŸç®¡ç†ç­–ç•¥

#### é—®é¢˜åˆ†æ

ä½¿ç”¨ Context Manager (`async with`) ä¼šå¯¼è‡´ Sandbox åœ¨é€€å‡ºæ—¶è‡ªåŠ¨å…³é—­ï¼š
```python
async with SandboxManager(...) as manager:
    # æ‰§è¡Œä»£ç 
    pass  # é€€å‡ºæ—¶ Sandbox è¢«å…³é—­ï¼ŒæœåŠ¡åœæ­¢
```

#### è§£å†³æ–¹æ¡ˆ

æ‰‹åŠ¨ç®¡ç†ç”Ÿå‘½å‘¨æœŸï¼Œä¸ä½¿ç”¨ Context Managerï¼š
```python
manager = SandboxManager(template_id, envs)
try:
    await manager.start()
    # æ‰§è¡Œä»£ç 
    # è·å– URL
    # ä¸è°ƒç”¨ manager.close()
except Exception as e:
    # åªåœ¨å‡ºé”™æ—¶å…³é—­
    await manager.close()
    raise
```

**ä¼˜åŠ¿**:
- Sandbox ä¿æŒè¿è¡Œï¼ŒæœåŠ¡æŒç»­å¯ç”¨
- ç”¨æˆ·å¯ä»¥é€šè¿‡æµè§ˆå™¨è®¿é—®æœåŠ¡
- è‡ªåŠ¨è¶…æ—¶æœºåˆ¶ï¼ˆ3600 ç§’ï¼‰ä¿è¯èµ„æºé‡Šæ”¾

### 4. é¢„æœŸä½¿ç”¨æµç¨‹

#### è¿è¡Œå‘½ä»¤
```bash
cd examples/demo/e2b_project
python src/apps/calculator.py
```

#### é¢„æœŸè¾“å‡º
```
ğŸ§® è®¡ç®—å™¨åº”ç”¨ç”Ÿæˆå™¨
============================================================
âœ… ç¯å¢ƒå˜é‡æ£€æŸ¥é€šè¿‡

ğŸ“‹ è¯»å– Template ID...
âœ… Template ID: or5xvfgibxlz5u6oa6p1
ğŸ“„ è¯»å–ä»£ç æ–‡ä»¶: calculator.py
âœ… ä»£ç å¤§å°: XXX å­—èŠ‚
ğŸš€ åˆ›å»º Sandbox...
âœ… Sandbox å·²åˆ›å»º (ID: abc123)
ğŸ“¤ ä¸Šä¼ ä»£ç åˆ° Sandbox: /home/user/workspace/calculator.py
âœ… ä»£ç æ–‡ä»¶å·²ä¸Šä¼ 

ğŸš€ æ‰§è¡Œä»£ç : python /home/user/workspace/calculator.py

==================================================
[Agent] æ­£åœ¨åˆ›å»ºè®¡ç®—å™¨åº”ç”¨...
[Agent] Creating index.html...
[Agent] å·²åˆ›å»ºç¾è§‚çš„è®¡ç®—å™¨ç•Œé¢
[Agent] Creating README.md...
[Agent] å¯åŠ¨ HTTP æœåŠ¡å™¨åœ¨ç«¯å£ 3000...
[Agent] âœ… æœåŠ¡å·²æˆåŠŸå¯åŠ¨
==================================================

âœ… æ‰§è¡Œå®Œæˆ (é€€å‡ºç : 0)

â³ ç­‰å¾…æœåŠ¡å¯åŠ¨ (5 ç§’)...
ğŸŒ è·å–æœåŠ¡ URL (ç«¯å£ 3000)...
âœ… æœåŠ¡ URL: https://abc123-3000.e2b.dev

ğŸ“‚ æ£€æŸ¥ç”Ÿæˆçš„æ–‡ä»¶...
âœ… ç”Ÿæˆçš„æ–‡ä»¶:
  - index.html
  - README.md

ğŸ’¡ æç¤º: Sandbox (ID: abc123) å°†ä¿æŒè¿è¡Œ
   - æœåŠ¡å°†æŒç»­å¯ç”¨ç›´åˆ° Sandbox è¶…æ—¶ï¼ˆé»˜è®¤ 3600 ç§’ï¼‰
   - å¦‚éœ€æ‰‹åŠ¨å…³é—­ï¼Œè¯·ä½¿ç”¨ E2B Dashboard æˆ– API

============================================================
ğŸ“Š æ‰§è¡Œç»“æœ
============================================================
âœ… é€€å‡ºç : 0
âœ… åº”ç”¨ç”ŸæˆæˆåŠŸ!

ğŸ“‚ ç”Ÿæˆçš„æ–‡ä»¶ (2 ä¸ª):
  - index.html
  - README.md

============================================================
ğŸŒ Web æœåŠ¡ä¿¡æ¯
============================================================
âœ… å‰ç«¯åœ°å€: https://abc123-3000.e2b.dev
âœ… Sandbox ID: abc123

ğŸ’¡ ä½¿ç”¨æç¤º:
  1. åœ¨æµè§ˆå™¨ä¸­æ‰“å¼€ä¸Šè¿°åœ°å€è®¿é—®è®¡ç®—å™¨åº”ç”¨
  2. Sandbox å°†ä¿æŒè¿è¡Œçº¦ 1 å°æ—¶ï¼ˆ3600 ç§’ï¼‰
  3. æœåŠ¡è¶…æ—¶åä¼šè‡ªåŠ¨å…³é—­
============================================================
```

#### ç”¨æˆ·ä½“éªŒ
1. è¿è¡Œè„šæœ¬åè·å¾—å¤–éƒ¨ HTTPS URL
2. åœ¨æµè§ˆå™¨ä¸­æ‰“å¼€ URL
3. çœ‹åˆ°ç¾è§‚çš„è®¡ç®—å™¨ Web ç•Œé¢
4. å¯ä»¥è¿›è¡Œè®¡ç®—æ“ä½œ
5. æœåŠ¡åœ¨çº¦ 1 å°æ—¶åè‡ªåŠ¨åœæ­¢

### 5. æŠ€æœ¯è¦ç‚¹æ€»ç»“

#### E2B Sandbox ç«¯å£æš´éœ²

**è‡ªåŠ¨ HTTPS URL ç”Ÿæˆ**:
- æ¯ä¸ªç«¯å£è‡ªåŠ¨è·å¾—ç‹¬ç«‹çš„å¤–éƒ¨ URL
- URL æ ¼å¼ï¼š`https://{sandbox_id}-{port}.e2b.dev`
- æ”¯æŒæ ‡å‡† HTTP/HTTPS åè®®
- è‡ªåŠ¨ SSL/TLS è¯ä¹¦é…ç½®

**API ä½¿ç”¨**:
```python
# æ¨èæ–¹å¼
url = sandbox.get_hostname(port=3000)
# è¿”å›: https://xxx-3000.e2b.dev

# æˆ–è€…
host = sandbox.get_host(3000)
url = f"https://{host}"
```

#### Sandbox ç”Ÿå‘½å‘¨æœŸ

**è¿è¡Œæ—¶é•¿**:
- é»˜è®¤è¶…æ—¶ï¼š3600 ç§’ï¼ˆ1 å°æ—¶ï¼‰
- å¯åœ¨åˆ›å»ºæ—¶é…ç½®ï¼š`Async Sandbox.create(template=..., timeout=7200)`
- è¶…æ—¶å Sandbox è‡ªåŠ¨å…³é—­ï¼Œèµ„æºé‡Šæ”¾

**æ‰‹åŠ¨ç®¡ç†**:
```python
# åˆ›å»ºä½†ä¸è‡ªåŠ¨å…³é—­
manager = SandboxManager(...)
await manager.start()
# ... ä½¿ç”¨ Sandbox
# ä¸è°ƒç”¨ manager.close()ï¼Œä¿æŒè¿è¡Œ
```

#### Web æœåŠ¡å¯åŠ¨

**åå°è¿è¡Œæ–¹å¼**:
```bash
# æ–¹å¼ 1: åå°è¿è¡Œ
python -m http.server 3000 > /dev/null 2>&1 &

# æ–¹å¼ 2: nohup
nohup python -m http.server 3000 &

# æ–¹å¼ 3: åœ¨ Python ä¸­
import subprocess
subprocess.Popen(["python", "-m", "http.server", "3000"])
```

**ç­‰å¾…æœåŠ¡å°±ç»ª**:
```python
await asyncio.sleep(3)  # ç®€å•ç­‰å¾…
# æˆ–ä½¿ç”¨å¥åº·æ£€æŸ¥
async with httpx.AsyncClient() as client:
    for _ in range(10):
        try:
            response = await client.get(url)
            if response.status_code < 500:
                break
        except:
            await asyncio.sleep(1)
```

## ğŸ¯ å®æ–½æˆæœ

### åŠŸèƒ½å¢å¼º
- âœ… ä»å‘½ä»¤è¡Œå·¥å…· â†’ Web åº”ç”¨
- âœ… æœ¬åœ°æ‰§è¡Œ â†’ äº‘ç«¯éƒ¨ç½²
- âœ… æ‰‹åŠ¨æµ‹è¯• â†’ è‡ªåŠ¨è®¿é—® URL

### æ¶æ„ä¼˜åŒ–
- âœ… æ–°å¢ `run_code_with_service()` ä¸“ç”¨å‡½æ•°
- âœ… Sandbox ç”Ÿå‘½å‘¨æœŸçµæ´»ç®¡ç†
- âœ… æœåŠ¡ URL è‡ªåŠ¨è·å–å’Œæ˜¾ç¤º

### ç”¨æˆ·ä½“éªŒ
- âœ… ä¸€é”®ç”Ÿæˆå¹¶éƒ¨ç½² Web åº”ç”¨
- âœ… è·å¾—å¤–éƒ¨å¯è®¿é—®çš„ HTTPS URL
- âœ… æœåŠ¡è‡ªåŠ¨ä¿æŒè¿è¡Œ
- âœ… å®Œæ•´çš„ä½¿ç”¨æç¤ºå’Œè¯´æ˜

## ğŸ’¡ åç»­ä¼˜åŒ–å»ºè®®

### çŸ­æœŸå¢å¼º
1. **å¥åº·æ£€æŸ¥**: æ·»åŠ æœåŠ¡å¥åº·æ£€æŸ¥ç¡®è®¤æœåŠ¡å°±ç»ª
2. **è¶…æ—¶æé†’**: æ·»åŠ å€’è®¡æ—¶æé†’æœåŠ¡å³å°†è¶…æ—¶
3. **æ‰‹åŠ¨å…³é—­**: æä¾›è„šæœ¬æ”¯æŒæ‰‹åŠ¨å…³é—­ Sandbox

### é•¿æœŸä¼˜åŒ–
1. **æœåŠ¡ç®¡ç†**: å¼€å‘ Sandbox ç®¡ç†å·¥å…·ï¼ˆåˆ—è¡¨ã€å…³é—­ã€å»¶æœŸï¼‰
2. **å¤šç«¯å£æ”¯æŒ**: åŒæ—¶æš´éœ²å‰åç«¯å¤šä¸ªç«¯å£
3. **æŒä¹…åŒ–**: æ”¯æŒ Sandbox å¿«ç…§å’Œæ¢å¤
4. **ç›‘æ§**: æ·»åŠ æœåŠ¡å¥åº·ç›‘æ§å’Œå‘Šè­¦

## ğŸ“š ç›¸å…³æ–‡æ¡£

### E2B æ–‡æ¡£
- Port Forwarding: https://e2b.dev/docs/sandbox/port-forwarding
- Sandbox API: https://e2b.dev/docs/sdk/api-reference

### é¡¹ç›®è®°å¿†
- `session_2025-10-28_step5_agent_sdk_integration` - ç¬¬5æ­¥åŸºç¡€å®ç°
- `e2b_project_checkpoint_2025-10-28_step4_complete` - ç¬¬4æ­¥æ£€æŸ¥ç‚¹
- **æœ¬æ–‡ä»¶** - Web æœåŠ¡é›†æˆå¢å¼º

## âœ… éªŒè¯æ¸…å•

### åŠŸèƒ½éªŒè¯
- âœ… `code/calculator.py` æ›´æ–°ä¸ºç”Ÿæˆ Web åº”ç”¨
- âœ… `agent_runner.py` æ–°å¢ `run_code_with_service()` å‡½æ•°
- âœ… `apps/calculator.py` ä½¿ç”¨æ–°å‡½æ•°å¹¶æ˜¾ç¤º URL
- âœ… Sandbox ç”Ÿå‘½å‘¨æœŸæ­£ç¡®ç®¡ç†
- âœ… æœåŠ¡ URL æ­£ç¡®è·å–

### ä»£ç è´¨é‡
- âœ… ç±»å‹æ³¨è§£å®Œæ•´
- âœ… æ–‡æ¡£å­—ç¬¦ä¸²è¯¦ç»†
- âœ… é”™è¯¯å¤„ç†å®Œå–„
- âœ… ç”¨æˆ·æç¤ºæ¸…æ™°

### æ¶æ„è®¾è®¡
- âœ… å‡½æ•°èŒè´£å•ä¸€
- âœ… å‘åå…¼å®¹ï¼ˆä¿ç•™åŸæœ‰å‡½æ•°ï¼‰
- âœ… æ˜“äºæ‰©å±•ï¼ˆæ”¯æŒå¤šç«¯å£ï¼‰
